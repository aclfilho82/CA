<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Plataforma OncolÃ³gica â€“ PrÃ©-Quimioterapia</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: #f4f6f9;
        display: flex;
    }

    /* SIDEBAR */
    .sidebar {
        width: 260px;
        background: #002b50;
        color: white;
        min-height: 100vh;
        padding: 22px;
        position: fixed;
    }
    .sidebar h1 {
        font-size: 20px;
        margin-bottom: 30px;
        font-weight: 600;
        text-align: center;
    }
    .menu-item {
        padding: 12px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
    }
    .menu-item:hover {
        background: rgba(255,255,255,0.25);
    }

    /* CONTEÃšDO */
    .container {
        margin-left: 290px;
        padding: 30px;
        width: calc(100% - 290px);
    }

    h2 {
        color: #002b50;
        margin-bottom: 15px;
        font-size: 22px;
        font-weight: 600;
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 14px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }

    label {
        display: block;
        margin-top: 12px;
        font-weight: 600;
    }
    input, textarea, select {
        width: 97%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #cfd9e1;
        margin-top: 4px;
        font-size: 15px;
        background: #fafbfc;
    }
    textarea {
        height: 85px;
    }

    .btn {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
        margin-right: 8px;
        transition: 0.2s;
        font-weight: 600;
        color: white;
    }
    .azul { background: #0066cc; }
    .verde { background: #2e7d32; }
    .vermelho { background: #c62828; }
    .cinza { background: #555; }

    /* TABELA */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th {
        background: #002b50;
        color: white;
        padding: 12px;
        font-size: 14px;
    }
    td {
        padding: 12px;
        font-size: 14px;
        border-bottom: 1px solid #e1e6eb;
    }

    /* RESULTADO */
    .resultado { display:none; padding:20px; border-radius:12px; margin-top:20px; }
    .ok { background:#dbffe1; border-left:8px solid #1f8f3a; }
    .alerta { background:#fff7d1; border-left:8px solid #d4a017; }
    .erro { background:#ffe0e0; border-left:8px solid #b30000; }

    .tag {
        padding: 6px 12px;
        display:inline-block;
        margin-top:10px;
        border-radius:6px;
        font-weight:600;
        font-size:13px;
    }
    .risco-baixo { background:#d6f5e3; color:#0f6b39; }
    .risco-moderado { background:#fff2c2; color:#9a7700; }
    .risco-alto { background:#ffd4d4; color:#a30000; }

    @media (max-width: 900px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; position: relative; min-height: auto; }
        .container { margin-left: 0; width: 100%; padding: 15px; }
    }
</style>
</head>
<body>

<!-- MENU LATERAL -->
<div class="sidebar">
    <h1>Plataforma OncolÃ³gica</h1>
    <div class="menu-item" onclick="mostrarTela('telaLista')">ðŸ“‹ Lista de Pacientes</div>
    <div class="menu-item" onclick="novoPaciente()">âž• Novo Paciente</div>
</div>

<!-- CONTEÃšDO -->
<div class="container">

    <!-- TELA LISTA -->
    <div id="telaLista" class="card">
        <h2>Pacientes Cadastrados</h2>
        <button class="btn azul" onclick="novoPaciente()">+ Novo Paciente</button>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Nome Social</th>
                    <th>Idade</th>
                    <th>NÂº SUS</th>
                    <th>MÃ£e</th>
                    <th>Sexo</th>
                    <th>ProntuÃ¡rio</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="listaPacientes"></tbody>
        </table>
    </div>

    <!-- TELA CADASTRO -->
    <div id="telaCadastro" class="card" style="display:none;">
        <h2>Cadastro do Paciente</h2>

        <label>Nome Completo</label>
        <input id="nome">

        <label>Nome Social</label>
        <input id="nomeSocial">

        <label>Data de Nascimento</label>
        <input id="nascimento" type="date" onchange="calcularIdade()">

        <label>Idade</label>
        <input id="idade" readonly>

        <label>NÃºmero do SUS</label>
        <input id="sus">

        <label>Nome da MÃ£e</label>
        <input id="mae">

        <label>Sexo</label>
        <select id="sexo">
            <option value="">Selecioneâ€¦</option>
            <option>Masculino</option>
            <option>Feminino</option>
            <option>Outro</option>
        </select>

        <label>ProntuÃ¡rio</label>
        <input id="prontuario">

        <label>CID</label>
        <input id="cid">

        <label>ObservaÃ§Ãµes</label>
        <textarea id="obs"></textarea>

        <button class="btn azul" onclick="salvarPaciente()">Salvar</button>
        <button class="btn cinza" onclick="mostrarTela('telaLista')">Cancelar</button>
    </div>

    <!-- TELA AVALIAÃ‡ÃƒO -->
    <div id="telaExames" class="card" style="display:none;">
        <h2>AvaliaÃ§Ã£o â€“ <span id="nomePacienteTitulo"></span></h2>

        <label>NeutrÃ³filos (/mmÂ³)</label><input id="neut">
        <label>Plaquetas (/mmÂ³)</label><input id="plat">
        <label>Hemoglobina (g/dL)</label><input id="hb">
        <label>TGO</label><input id="tgo">
        <label>TGP</label><input id="tgp">
        <label>Bilirrubina Total</label><input id="bili">
        <label>Creatinina</label><input id="creat">
        <label>TFG</label><input id="tfg">

        <button class="btn verde" onclick="avaliar()">Avaliar</button>

        <div id="resultado" class="resultado"></div>
    </div>

    <!-- TELA EXAMES ANEXADOS -->
    <div id="cardExamesArquivos" class="card" style="display:none;">
        <h2>Exames Anexados</h2>

        <input type="file" id="inputExame" accept=".pdf,image/*">
        <button class="btn azul" onclick="anexarExame()">Anexar Exame</button>

        <h3>Lista de Exames</h3>
        <ul id="listaExames"></ul>
    </div>
</div>

<script>

let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];
let pacienteSelecionado = null;

/* =============== FUNÃ‡Ã•ES GERAIS ================= */

function mostrarTela(id){
    ["telaLista","telaCadastro","telaExames","cardExamesArquivos"]
    .forEach(t => document.getElementById(t).style.display="none");

    document.getElementById(id).style.display="block";
}

function calcularIdade(){
    const nasc = document.getElementById("nascimento").value;
    if(!nasc) return;

    let hoje = new Date();
    let dn = new Date(nasc);

    let idade = hoje.getFullYear() - dn.getFullYear();
    const mes = hoje.getMonth() - dn.getMonth();
    if(mes < 0 || (mes === 0 && hoje.getDate() < dn.getDate())) idade--;

    document.getElementById("idade").value = idade;
}

/* =============== LISTA ================= */

function atualizarLista(){
    const tb = document.getElementById("listaPacientes");
    tb.innerHTML = "";

    pacientes.forEach((p,i)=>{
        tb.innerHTML += `
        <tr>
            <td>${p.nome}</td>
            <td>${p.nomeSocial || ""}</td>
            <td>${p.idade}</td>
            <td>${p.sus}</td>
            <td>${p.mae}</td>
            <td>${p.sexo}</td>
            <td>${p.prontuario}</td>
            <td>
                <button class="btn azul" onclick="editarPaciente(${i})">Editar</button>
                <button class="btn verde" onclick="avaliarPaciente(${i})">Avaliar</button>
                <button class="btn vermelho" onclick="excluirPaciente(${i})">Excluir</button>
            </td>
        </tr>`;
    });
}
atualizarLista();

/* =============== NOVO PACIENTE ================= */

function novoPaciente(){
    pacienteSelecionado = null;

    ["nome","nomeSocial","nascimento","idade","sus","mae","sexo","prontuario","cid","obs"]
    .forEach(id => document.getElementById(id).value = "");

    mostrarTela("telaCadastro");
}

/* =============== SALVAR PACIENTE (COM NOME SOCIAL) ================= */

function salvarPaciente(){
    const nome        = document.getElementById("nome").value.trim();
    const nomeSocial  = document.getElementById("nomeSocial").value.trim();
    const nascimento  = document.getElementById("nascimento").value;
    const idade       = document.getElementById("idade").value;
    const sus         = document.getElementById("sus").value.trim();
    const mae         = document.getElementById("mae").value.trim();
    const sexo        = document.getElementById("sexo").value;
    const prontuario  = document.getElementById("prontuario").value.trim();
    const cid         = document.getElementById("cid").value.trim();
    const obs         = document.getElementById("obs").value.trim();

    if(!nome){
        alert("Digite o nome do paciente.");
        return;
    }

    const avaliacoesExistentes =
        (pacienteSelecionado !== null && pacientes[pacienteSelecionado].avaliacoes)
        ? pacientes[pacienteSelecionado].avaliacoes : [];

    const examesExistentes =
        (pacienteSelecionado !== null && pacientes[pacienteSelecionado].exames)
        ? pacientes[pacienteSelecionado].exames : [];

    const p = {
        nome, 
        nomeSocial,
        nascimento, 
        idade, 
        sus, 
        mae, 
        sexo,
        prontuario,
        cid,
        obs,
        avaliacoes: avaliacoesExistentes,
        exames: examesExistentes
    };

    if(pacienteSelecionado === null){
        pacientes.push(p);
    } else {
        pacientes[pacienteSelecionado] = p;
    }

    localStorage.setItem("pacientes", JSON.stringify(pacientes));
    atualizarLista();
    mostrarTela("telaLista");
}

/* =============== EDITAR ================= */

function editarPaciente(i){
    pacienteSelecionado = i;
    const p = pacientes[i];

    document.getElementById("nome").value = p.nome;
    document.getElementById("nomeSocial").value = p.nomeSocial || "";
    document.getElementById("nascimento").value = p.nascimento;
    document.getElementById("idade").value = p.idade;
    document.getElementById("sus").value = p.sus;
    document.getElementById("mae").value = p.mae;
    document.getElementById("sexo").value = p.sexo;
    document.getElementById("prontuario").value = p.prontuario;
    document.getElementById("cid").value = p.cid;
    document.getElementById("obs").value = p.obs;

    mostrarTela("telaCadastro");
}

/* =============== AVALIAÃ‡ÃƒO ================= */

function avaliarPaciente(i){
    pacienteSelecionado = i;
    document.getElementById("nomePacienteTitulo").innerText = pacientes[i].nome;

    ["neut","plat","hb","tgo","tgp","bili","creat","tfg"]
    .forEach(id => document.getElementById(id).value = "");

    mostrarTela("telaExames");
    atualizarListaExames();
    document.getElementById("cardExamesArquivos").style.display = "block";
}

/* =============== SALVAR RESULTADO ================= */

function avaliar(){
    const neutV = Number(neut.value);
    const platV = Number(plat.value);
    const hbV   = Number(hb.value);
    const tgoV  = Number(tgo.value);
    const tgpV  = Number(tgp.value);
    const biliV = Number(bili.value);
    const creatV = Number(creat.value);
    const tfgV = Number(tfg.value);

    let status = "Apto";
    let motivos = [];

    if(neutV && neutV < 1500){ status="NÃ£o Apto"; motivos.push("NeutrÃ³filos < 1500"); }
    if(platV && platV < 100000){ status="NÃ£o Apto"; motivos.push("Plaquetas < 100.000"); }
    if(hbV && hbV < 8){ if(status!=="NÃ£o Apto") status="Reavaliar"; motivos.push("Hemoglobina < 8"); }
    if(tgoV>80 || tgpV>80){ if(status!=="NÃ£o Apto") status="Reavaliar"; motivos.push("TGO/TGP alterados"); }
    if(biliV>1.5){ status="NÃ£o Apto"; motivos.push("Bilirrubina > 1.5"); }
    if(tfgV < 30){ status="NÃ£o Apto"; motivos.push("TFG < 30"); }

    let risco = "";
    let classe = "";
    if(status=="NÃ£o Apto"){ risco="Alto risco"; classe="risco-alto"; }
    else if(status=="Reavaliar"){ risco="Risco moderado"; classe="risco-moderado"; }
    else { risco="Baixo risco"; classe="risco-baixo"; }

    const r = document.getElementById("resultado");
    r.style.display = "block";
    r.className = "resultado " +
        (status=="Apto" ? "ok" :
         status=="Reavaliar" ? "alerta" : "erro");

    r.innerHTML = `
        <h3>${status}</h3>
        <span class="tag ${classe}">${risco}</span>
        <p><b>Motivos:</b><br>${motivos.join("<br>")}</p>

        <button class="btn azul" onclick="avaliarPaciente(${pacienteSelecionado})">Nova AvaliaÃ§Ã£o</button>
        <button class="btn cinza" onclick="mostrarTela('telaLista')">Voltar</button>
        <button class="btn verde" onclick="gerarPDF('${status}','${risco}','${motivos.join("\\n")}')">PDF</button>
    `;

    pacientes[pacienteSelecionado].avaliacoes.push({
        dataHora: new Date().toISOString(),
        status: status,
        risco: risco,
        neut: neutV, plat: platV, hb: hbV,
        tgo: tgoV, tgp: tgpV, bili: biliV,
        creat: creatV, tfg: tfgV
    });

    localStorage.setItem("pacientes", JSON.stringify(pacientes));
}

/* =============== PDF ================= */

function gerarPDF(status, risco, motivos){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const p = pacientes[pacienteSelecionado];

    doc.setFontSize(18);
    doc.text("Laudo PrÃ©-Quimioterapia", 20, 20);

    doc.setFontSize(12);
    doc.text(`Paciente: ${p.nome}`, 20, 40);
    doc.text(`Nome Social: ${p.nomeSocial || "-"}`, 20, 50);
    doc.text(`MÃ£e: ${p.mae}`, 20, 60);
    doc.text(`Nascimento: ${p.nascimento}`, 20, 70);
    doc.text(`Idade: ${p.idade}`, 20, 80);
    doc.text(`NÂº SUS: ${p.sus}`, 20, 90);
    doc.text(`ProntuÃ¡rio: ${p.prontuario}`, 20, 100);
    doc.text(`CID: ${p.cid}`, 20, 110);

    doc.text(`Status: ${status}`, 20, 130);
    doc.text(`Risco: ${risco}`, 20, 140);
    doc.text("Motivos:", 20, 160);
    doc.text(motivos, 20, 170);

    doc.save("laudo_"+p.nome+".pdf");
}

/* =============== EXAMES ================= */

function atualizarListaExames(){
    const ul = document.getElementById("listaExames");
    const card = document.getElementById("cardExamesArquivos");
    const p = pacientes[pacienteSelecionado];

    card.style.display = "block";

    if(!p.exames || p.exames.length === 0){
        ul.innerHTML = "<li>Nenhum exame anexado ainda.</li>";
        return;
    }

    let html = "";
    p.exames.forEach((ex,i)=>{
        const dataLabel = new Date(ex.dataHora)
            .toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"});
        html += `
        <li style="margin-bottom:10px;">
            <strong>${ex.nome}</strong> (${dataLabel})
            - <a href="${ex.dados}" target="_blank">Ver</a>
            <button class="btn vermelho" style="padding:4px 8px; font-size:12px;"
                    onclick="removerExame(${i})">
                Remover
            </button>
        </li>`;
    });

    ul.innerHTML = html;
}

function anexarExame(){
    const file = document.getElementById("inputExame").files[0];
    if(!file){ alert("Selecione um arquivo."); return;}

    const reader = new FileReader();
    reader.onload = function(e){
        const p = pacientes[pacienteSelecionado];

        if(!p.exames) p.exames = [];

        p.exames.push({
            nome: file.name,
            tipo: file.type,
            dados: e.target.result,
            dataHora: new Date().toISOString()
        });

        localStorage.setItem("pacientes", JSON.stringify(pacientes));
        atualizarListaExames();
    };

    reader.readAsDataURL(file);
}

function removerExame(i){
    const p = pacientes[pacienteSelecionado];
    p.exames.splice(i,1);
    localStorage.setItem("pacientes", JSON.stringify(pacientes));
    atualizarListaExames();
}

/* =============== EXCLUIR ================= */

function excluirPaciente(i){
    if(confirm("Excluir paciente?")){
        pacientes.splice(i,1);
        localStorage.setItem("pacientes", JSON.stringify(pacientes));
        atualizarLista();
    }
}

</script>

</body>
</html>
